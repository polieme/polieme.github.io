<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xydcom.cn","root":"/","images":"/images","scheme":"Gemini","version":"8.3.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta property="og:type" content="article">
<meta property="og:title" content="第7章 使用性能利器Redis">
<meta property="og:url" content="http://xydcom.cn/2019/05/25/%E7%AC%AC7%E7%AB%A0-%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8Redis/index.html">
<meta property="og:site_name" content="Daniel&#39;s Blog技术存放">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://xydcom.cn/images/banner/banner_53.jpg">
<meta property="og:image" content="http://xydcom.cn/2019/05/25/%E7%AC%AC7%E7%AB%A0-%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8Redis/screenshot_1.png">
<meta property="og:image" content="http://xydcom.cn/2019/05/25/%E7%AC%AC7%E7%AB%A0-%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8Redis/screenshot_2.png">
<meta property="article:published_time" content="2019-05-24T16:55:42.000Z">
<meta property="article:modified_time" content="2021-09-07T02:05:07.482Z">
<meta property="article:author" content="Daniel">
<meta property="article:tag" content="Spring Boot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xydcom.cn/images/banner/banner_53.jpg">


<link rel="canonical" href="http://xydcom.cn/2019/05/25/%E7%AC%AC7%E7%AB%A0-%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8Redis/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>第7章 使用性能利器Redis | Daniel's Blog技术存放</title>
  

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?54f260792b0ce4401620db3ee3bb5b52";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Daniel's Blog技术存放</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">生死看淡，不服就干</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-java"><a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Java/" rel="section"><i class="fa fa-bug fa-fw"></i>Java</a></li>
        <li class="menu-item menu-item-javascript"><a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/Javascript/" rel="section"><i class="fab fa-xing fa-fw"></i>Javascript</a></li>
        <li class="menu-item menu-item-jquery"><a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/JQuery/" rel="section"><i class="fa fa-bolt fa-fw"></i>JQuery</a></li>
        <li class="menu-item menu-item-css"><a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/CSS/" rel="section"><i class="fab fa-css3 fa-fw"></i>CSS</a></li>
        <li class="menu-item menu-item-android"><a href="/categories/%E7%A7%BB%E5%8A%A8%E7%AB%AF/Android/" rel="section"><i class="fab fa-android fa-fw"></i>Android</a></li>
        <li class="menu-item menu-item-后端框架"><a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/" rel="section"><i class="fab fa-modx fa-fw"></i>后端框架</a></li>
        <li class="menu-item menu-item-后端插件"><a href="/categories/%E5%90%8E%E7%AB%AF%E6%8F%92%E4%BB%B6/" rel="section"><i class="fab fa-opera fa-fw"></i>后端插件</a></li>
        <li class="menu-item menu-item-前端框架"><a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/" rel="section"><i class="fa fa-gem fa-fw"></i>前端框架</a></li>
        <li class="menu-item menu-item-前端插件"><a href="/categories/%E5%89%8D%E7%AB%AF%E6%8F%92%E4%BB%B6/" rel="section"><i class="fa fa-crop fa-fw"></i>前端插件</a></li>
        <li class="menu-item menu-item-安全测评"><a href="/categories/%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%84/" rel="section"><i class="fa fa-lock fa-fw"></i>安全测评</a></li>
        <li class="menu-item menu-item-办公知识"><a href="/categories/%E5%8A%9E%E5%85%AC%E7%9F%A5%E8%AF%86/" rel="section"><i class="fa fa-dot-circle fa-fw"></i>办公知识</a></li>
        <li class="menu-item menu-item-服务器"><a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="section"><i class="fa fa-server fa-fw"></i>服务器</a></li>
        <li class="menu-item menu-item-中间件"><a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="section"><i class="fa fa-arrows-alt fa-fw"></i>中间件</a></li>
        <li class="menu-item menu-item-数据库"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="section"><i class="fa fa-database fa-fw"></i>数据库</a></li>
        <li class="menu-item menu-item-物联网"><a href="/categories/%E7%89%A9%E8%81%94%E7%BD%91/" rel="section"><i class="fa fa-link fa-fw"></i>物联网</a></li>
        <li class="menu-item menu-item-软件安装"><a href="/categories/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" rel="section"><i class="fa fa-th-large fa-fw"></i>软件安装</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">222</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">103</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">191</span></a></li>
        <li class="menu-item menu-item-待完善"><a href="/todo/" rel="section"><i class="fa fa-paper-plane fa-fw"></i>待完善</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8Redis"><span class="nav-number">1.</span> <span class="nav-text">使用性能利器Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8Spring-Boot%E4%B8%AD%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BD%BF%E7%94%A8Redis"><span class="nav-number">1.1.</span> <span class="nav-text">在Spring Boot中配置和使用Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8Spring-Boot%E4%B8%AD%E9%85%8D%E7%BD%AERedis"><span class="nav-number">1.1.1.</span> <span class="nav-text">在Spring Boot中配置Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9CRedis%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.1.2.</span> <span class="nav-text">操作Redis数据类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%AE%8A%E7%94%A8%E6%B3%95"><span class="nav-number">1.2.</span> <span class="nav-text">Redis的一些特殊用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Redis%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.2.1.</span> <span class="nav-text">使用Redis事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Redis%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-number">1.2.2.</span> <span class="nav-text">使用Redis流水线</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="nav-number">1.2.3.</span> <span class="nav-text">使用Redis发布订阅</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Lua%E8%84%9A%E6%9C%AC"><span class="nav-number">1.2.4.</span> <span class="nav-text">使用Lua脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Spring%E7%BC%93%E5%AD%98%E6%B3%A8%E8%A7%A3%E6%93%8D%E4%BD%9CRedis"><span class="nav-number">1.3.</span> <span class="nav-text">使用Spring缓存注解操作Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%AE%A1%E7%90%86%E5%99%A8%E5%92%8C%E7%BC%93%E5%AD%98%E7%9A%84%E5%90%AF%E7%94%A8"><span class="nav-number">1.3.1.</span> <span class="nav-text">缓存管理器和缓存的启用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E7%BC%93%E5%AD%98%E6%B3%A8%E8%A7%A3"><span class="nav-number">1.3.2.</span> <span class="nav-text">开发缓存注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E6%B3%A8%E8%A7%A3%E8%87%AA%E8%B0%83%E7%94%A8%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.3.</span> <span class="nav-text">缓存注解自调用失效问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E8%84%8F%E6%95%B0%E6%8D%AE%E8%AF%B4%E6%98%8E"><span class="nav-number">1.3.4.</span> <span class="nav-text">缓存脏数据说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%93%E5%AD%98%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">1.3.5.</span> <span class="nav-text">自定义缓存管理器</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Daniel"
      src="/images/head/head_pic.jpg#/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Daniel</p>
  <div class="site-description" itemprop="description">生死看淡，不服就干</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">191</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">103</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/polieme" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;polieme" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/polieme@126.com" title="E-Mail → polieme@126.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/polieme" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xydcom.cn/2019/05/25/%E7%AC%AC7%E7%AB%A0-%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head/head_pic.jpg#/images/avatar.gif">
      <meta itemprop="name" content="Daniel">
      <meta itemprop="description" content="生死看淡，不服就干">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Daniel's Blog技术存放">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第7章 使用性能利器Redis
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-25 00:55:42" itemprop="dateCreated datePublished" datetime="2019-05-25T00:55:42+08:00">2019-05-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-07 10:05:07" itemprop="dateModified" datetime="2021-09-07T10:05:07+08:00">2021-09-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">后端开发框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description"> </div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="/images/banner/banner_53.jpg"></p>
<h1 id="使用性能利器Redis"><a href="#使用性能利器Redis" class="headerlink" title="使用性能利器Redis"></a>使用性能利器Redis</h1><p>要使用Redis，需要先加入Redis依赖，代码如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Redis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入Redis的客户端驱动jedis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样我们就引入了Spring对Redis的starter，只是在默认的情况下，spring-boot-starter-data-redis会依赖Lettuce的Redis客户端驱动，一般项目中我们会使用Jedis，所以代码中使用<exliusions>元素将依赖排除，然后再引入Jedis的依赖</p>
<h2 id="在Spring-Boot中配置和使用Redis"><a href="#在Spring-Boot中配置和使用Redis" class="headerlink" title="在Spring Boot中配置和使用Redis"></a>在Spring Boot中配置和使用Redis</h2><h3 id="在Spring-Boot中配置Redis"><a href="#在Spring-Boot中配置Redis" class="headerlink" title="在Spring Boot中配置Redis"></a>在Spring Boot中配置Redis</h3><p>只需要在配置文件application.properties中加入如下代码</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Redis</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.min-idle</span>=<span class="string">5</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">2000ms</span></span><br><span class="line"><span class="comment">#配置Redis服务器属性</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment">#Redis连接超时时间，单位毫秒</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">1000ms</span></span><br></pre></td></tr></table></figure>
<p>RedisTemplate会默认使用JdkSerializationRedisSerializer进行序列化键值，这样便能够存储在Redis服务器中。如果这样Redis服务器存入的便是一个经过序列化后的特殊字符串，有时候对于我们跟踪并不是很友好。如果我们在Redis只是支持字符串，并不能支持Java对象存储。为了克服这个问题，可以通过设置RedisTemplate的序列化来处理。下面我们在Spring Boot中配置Redis的启动文件中修改RedisTemplate的序列化器，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">McApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入RedisTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义自定义后初始化方法</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        initRedisTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置RedisTemplate的序列化器</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initRedisTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisSerializer stringSerializer = redisTemplate.getStringSerializer();</span><br><span class="line">        redisTemplate.setKeySerializer(stringSerializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(stringSerializer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(McApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过@Autowired注入由Spring Boot根据配置生成的RedisTemplate对象，然后利用Spring Bean生命周期的特性使用注解@PostConstruct自定义后初始化方法。在这个方法里，把RedisTemplate的键序列化器修改为StringRedisSerializer。RedisTemplate中默认的定义了一个StringRedisSerializer对象，所以不需要创建新的，直接从中取，然后把RedisTemplate关于键和散列数据类型的field都修改为使用StringRedisSerializer进行序列化，这样我们在Redis服务器上得到的键和散列的field就都可以字符串存储了</p>
<h3 id="操作Redis数据类型"><a href="#操作Redis数据类型" class="headerlink" title="操作Redis数据类型"></a>操作Redis数据类型</h3><p>首先简单介绍下RedisTemplate的使用</p>
<ol>
<li>操作字符串和hash数据<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyd.mc.demo.redis.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.BoundHashOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;redis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/stringAndHash&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">stringAndHash</span><span class="params">()</span></span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;key1&quot;</span>,<span class="string">&quot;value1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里使用了JDK的序列化，所以Redis保存时不是整数，不能运算</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;int_key&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;int&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用运算</span></span><br><span class="line">        stringRedisTemplate.opsForValue().increment(<span class="string">&quot;int&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//对int减一（书上说的可能比较早了，现在是支持减一操作的）</span></span><br><span class="line">        stringRedisTemplate.opsForValue().decrement(<span class="string">&quot;int&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取底层Hedis连接</span></span><br><span class="line">        Jedis jedis = (Jedis) stringRedisTemplate.getConnectionFactory().getConnection().getNativeConnection();</span><br><span class="line">        <span class="comment">//减1操作，这个命令RedisTemplate不支持，所以我们先获取底层的连接再操作</span></span><br><span class="line">        jedis.decr(<span class="string">&quot;int&quot;</span>);</span><br><span class="line">        Map&lt;String,String&gt; hash = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        hash.put(<span class="string">&quot;field1&quot;</span>,<span class="string">&quot;value1&quot;</span>);</span><br><span class="line">        hash.put(<span class="string">&quot;field2&quot;</span>,<span class="string">&quot;value2&quot;</span>);</span><br><span class="line">        <span class="comment">//存入一个散列数据类型</span></span><br><span class="line">        stringRedisTemplate.opsForHash().putAll(<span class="string">&quot;hash&quot;</span>,hash);</span><br><span class="line">        <span class="comment">//新增一个字段</span></span><br><span class="line">        stringRedisTemplate.opsForHash().put(<span class="string">&quot;hash&quot;</span>,<span class="string">&quot;field3&quot;</span>,<span class="string">&quot;value3&quot;</span>);</span><br><span class="line">        <span class="comment">//绑定散列操作的key，这样可以连续对同一个散列数据类型进行操作</span></span><br><span class="line">        BoundHashOperations hashOps = stringRedisTemplate.boundHashOps(<span class="string">&quot;hash&quot;</span>);</span><br><span class="line">        <span class="comment">//输出两个字段</span></span><br><span class="line">        hashOps.delete(<span class="string">&quot;field1&quot;</span>,<span class="string">&quot;field2&quot;</span>);</span><br><span class="line">        <span class="comment">//新增一个字段</span></span><br><span class="line">        hashOps.put(<span class="string">&quot;field4&quot;</span>,<span class="string">&quot;value4&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;success&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
这里@Autowired注入了Spring Boot为我们自动初始化的RediTemplate和StringRedisTemplate对象。看到testStringAndHash方法，首先存入一个key1的数据，然后是init_key，但是int_key存入Redis服务器中，因为采用了JDK序列化，所以Redis服务器中她不是证书，而是一个被JDK序列化器序列化后的二进制字符串，是没有办法使用Redis命令进行运算的。为了解决这个问题，这里使用StringRedisTemplate对象保存一个int的证书，这样就能够运算了，接着进行加一运算，但是因为RedisTemplate并不支持底层所有的Redis命令，所以这里现货区了原始的Redis连接的Jedis对象，用它来做减一操作。然后是操作散列数据类型，在插入多个散列的field时，可采用Map，然后为了方便对同一个数据操作，这里代码还获取了BoundHashOperations对象进行操作，这样对同一个数据操作就方便许多了。</li>
<li>操作列表数据<br>列表数据也是常用的数据类型，在Redis中列表是一种链表结构，这就意味着查询性能不高，而增删节点的性能高。在Redis中存在从左到右的操作，为了方便测试，我们在上面的代码中加入如下代码<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: stringRedisTemplate操作链表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>: []</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>: java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: zp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/8/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">list</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入两个列表，注意他们在链表的顺序</span></span><br><span class="line">    <span class="comment">//链表从左到右顺序为V10,V8,V6,V4,V2</span></span><br><span class="line">    stringRedisTemplate.opsForList().leftPushAll(<span class="string">&quot;list1&quot;</span>,<span class="string">&quot;v2&quot;</span>,<span class="string">&quot;v4&quot;</span>,<span class="string">&quot;v6&quot;</span>,<span class="string">&quot;v8&quot;</span>,<span class="string">&quot;v10&quot;</span>);</span><br><span class="line">    <span class="comment">//链表从左到右的顺序为v1,v2,v3,v4,v5,v6</span></span><br><span class="line">    stringRedisTemplate.opsForList().rightPushAll(<span class="string">&quot;list2&quot;</span>,<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;v2&quot;</span>,<span class="string">&quot;v3&quot;</span>,<span class="string">&quot;v4&quot;</span>,<span class="string">&quot;v5&quot;</span>,<span class="string">&quot;v6&quot;</span>);</span><br><span class="line">    <span class="comment">//绑定list2链表操作</span></span><br><span class="line">    BoundListOperations boundListOperations = stringRedisTemplate.boundListOps(<span class="string">&quot;list2&quot;</span>);</span><br><span class="line">    <span class="comment">//从右边弹出一个成员</span></span><br><span class="line">    Object result1 = boundListOperations.rightPop();</span><br><span class="line">    <span class="comment">//获取定位元素，Redis从0开始计算，这里值为v2</span></span><br><span class="line">    Object result2 = boundListOperations.index(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//从左边插入链表</span></span><br><span class="line">    boundListOperations.leftPush(<span class="string">&quot;v0&quot;</span>);</span><br><span class="line">    <span class="comment">//求链表长度</span></span><br><span class="line">    Long size = boundListOperations.size();</span><br><span class="line">    <span class="comment">//求链表下标区间成员，整个链表下标范围为0到size-1，这里不取最后一个元素</span></span><br><span class="line">    List elements = boundListOperations.range(<span class="number">0</span>,size-<span class="number">2</span>);</span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;success&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
上述操作是基于StringRedisTemplate的，所以保存到Redis服务器都是字符串类型，这里有两点需要注意。首先是列表元素的顺序问题，是从左到右还是从右到左，这是容易弄糊涂的问题，其次是下标，在Redis中是以0开始的，这与Java数组类似。</li>
<li>操作集合数据<br>在Redis中是不允许成员重复的，她在数据结构上是一个散列表的结构，所以对于它而言是无序的，对于两个或者以上的集合，Redis还提供了交集、并集和差集的运算。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: stringRedisTemplate操作集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>: []</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>: java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: zp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/8/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/set&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">set</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//注意：这里v1重复两次，因为集合不允许重复，所以只是插入5个成员到集合中</span></span><br><span class="line">    stringRedisTemplate.opsForSet().add(<span class="string">&quot;set1&quot;</span>,<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;v2&quot;</span>,<span class="string">&quot;v3&quot;</span>,<span class="string">&quot;v4&quot;</span>,<span class="string">&quot;v5&quot;</span>);</span><br><span class="line">    stringRedisTemplate.opsForSet().add(<span class="string">&quot;set2&quot;</span>,<span class="string">&quot;v2&quot;</span>,<span class="string">&quot;v4&quot;</span>,<span class="string">&quot;v6&quot;</span>,<span class="string">&quot;v8&quot;</span>);</span><br><span class="line">    <span class="comment">//绑定set1集合操作</span></span><br><span class="line">    BoundSetOperations boundSetOperations = stringRedisTemplate.boundSetOps(<span class="string">&quot;set1&quot;</span>);</span><br><span class="line">    <span class="comment">//增加两个元素</span></span><br><span class="line">    boundSetOperations.add(<span class="string">&quot;v6&quot;</span>,<span class="string">&quot;v7&quot;</span>);</span><br><span class="line">    <span class="comment">//删除两个元素</span></span><br><span class="line">    boundSetOperations.remove(<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;v7&quot;</span>);</span><br><span class="line">    <span class="comment">//返回所有元素</span></span><br><span class="line">    Set set1 = boundSetOperations.members();</span><br><span class="line">    <span class="comment">//求成员数</span></span><br><span class="line">    Long size = boundSetOperations.size();</span><br><span class="line">    <span class="comment">//求set1和set2交集</span></span><br><span class="line">    Set inter = boundSetOperations.intersect(<span class="string">&quot;set2&quot;</span>);</span><br><span class="line">    <span class="comment">//求交集，并且用新集合inter保存</span></span><br><span class="line">    boundSetOperations.intersectAndStore(<span class="string">&quot;set2&quot;</span>,<span class="string">&quot;inter&quot;</span>);</span><br><span class="line">    <span class="comment">//求差集</span></span><br><span class="line">    Set diff = boundSetOperations.diff(<span class="string">&quot;set2&quot;</span>);</span><br><span class="line">    <span class="comment">//求差集，并且用新集合diff保存</span></span><br><span class="line">    boundSetOperations.diffAndStore(<span class="string">&quot;set2&quot;</span>,<span class="string">&quot;diff&quot;</span>);</span><br><span class="line">    <span class="comment">//求并集</span></span><br><span class="line">    Set union = boundSetOperations.union(<span class="string">&quot;set2&quot;</span>);</span><br><span class="line">    <span class="comment">//求并集，并且用新集合union保存</span></span><br><span class="line">    boundSetOperations.unionAndStore(<span class="string">&quot;set2&quot;</span>,<span class="string">&quot;union&quot;</span>);</span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;success&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里在添加几个set1的时候，存在两个V1一样的元素，因为集合不允许重复，所以实际上再集合只算是一个元素。然后可以看到对集合各种操作，在最后还有交集、差集和并集的操作，这些是集合最常用的操作。</li>
<li>操作有序集合<br>有序集合常用作网站排名，有序集合和无序集合差异往往不大，也是一种散列表存储的方式，同时它的有序性只是靠她在数据结构中增加一个属性——score（分数）得以支持，为了支持这个变化，Spring提供TypeTuple接口，定义了两个方法，并且还提供了默认的实现类DefaultTypedTuple，在TypedTupl的接口设计中，value是保存有序集合的值，score是保存分数，Redis是使用分数来完成集合的排序<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 操作有序集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>: []</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>: java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: zp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/8/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/zset&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">zset</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">9</span>; i++)&#123;</span><br><span class="line">        <span class="comment">//分数</span></span><br><span class="line">        <span class="keyword">double</span> score = i*<span class="number">0.1</span>;</span><br><span class="line">        <span class="comment">//创建一个TypedTuple对象，存入值和分数</span></span><br><span class="line">        ZSetOperations.TypedTuple&lt;String&gt; typedTuple = <span class="keyword">new</span> DefaultTypedTuple&lt;&gt;(<span class="string">&quot;value&quot;</span>+i,score);</span><br><span class="line">        typedTuples.add(typedTuple);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//往有序集合插入元素</span></span><br><span class="line">    stringRedisTemplate.opsForZSet().add(<span class="string">&quot;zset1&quot;</span>,typedTuples);</span><br><span class="line">    <span class="comment">//绑定zset1有序集合操作</span></span><br><span class="line">    BoundZSetOperations&lt;String,String&gt; zSetOperations = stringRedisTemplate.boundZSetOps(<span class="string">&quot;zset1&quot;</span>);</span><br><span class="line">    <span class="comment">//增加一个元素</span></span><br><span class="line">    zSetOperations.add(<span class="string">&quot;value10&quot;</span>,<span class="number">0.26</span>);</span><br><span class="line">    Set&lt;String&gt; setRange = zSetOperations.range(<span class="number">1</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="comment">//按分数排序获取有序集合</span></span><br><span class="line">    Set&lt;String&gt; setScore = zSetOperations.rangeByScore(<span class="number">0.2</span>,<span class="number">0.6</span>);</span><br><span class="line">    <span class="comment">//定义值范围</span></span><br><span class="line">    RedisZSetCommands.Range range = <span class="keyword">new</span> RedisZSetCommands.Range();</span><br><span class="line">    range.gt(<span class="string">&quot;value3&quot;</span>);<span class="comment">//大于value3</span></span><br><span class="line">    <span class="comment">//range.gte(&quot;value3&quot;);//大于等于value3</span></span><br><span class="line">    <span class="comment">//range.lt(&quot;value8&quot;);//小于value8</span></span><br><span class="line">    range.lte(<span class="string">&quot;value8&quot;</span>);<span class="comment">//小于等于value8</span></span><br><span class="line">    <span class="comment">//按值排序，请注意这个排序是按字符串排序</span></span><br><span class="line">    Set&lt;String&gt; setLex = zSetOperations.rangeByLex(range);</span><br><span class="line">    <span class="comment">//删除元素</span></span><br><span class="line">    zSetOperations.remove(<span class="string">&quot;value9&quot;</span>,<span class="string">&quot;value2&quot;</span>);</span><br><span class="line">    <span class="comment">//求分数</span></span><br><span class="line">    Double score = zSetOperations.score(<span class="string">&quot;value8&quot;</span>);</span><br><span class="line">    <span class="comment">//在下标区间下，按分数排序，同时返回value和score</span></span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; rangeSet = zSetOperations.rangeWithScores(<span class="number">1</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="comment">//在分数区间下，按分数排序，同时返回value和score</span></span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; scoreSet = zSetOperations.rangeByScoreWithScores(<span class="number">1</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="comment">//按从大到小排序</span></span><br><span class="line">    Set&lt;String&gt; reverseSet = zSetOperations.reverseRange(<span class="number">2</span>,<span class="number">8</span>);</span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;success&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
代码中使用TypedTuple保存有序集合的元素，在默认的情况下，有序集合是从小到大地排序的，按下表、分数和值进行排序获取有序集合的元素，或者联通分数一期返回，有时候还可以进行从大到小的排序，只是在使用值排序时，我们可以使用Spring为我们创建的Range类，他可以定义值的范围</li>
</ol>
<h2 id="Redis的一些特殊用法"><a href="#Redis的一些特殊用法" class="headerlink" title="Redis的一些特殊用法"></a>Redis的一些特殊用法</h2><p>Redis支持事务、流水线、发布订阅和Lua语言等功能，<font color='red'>这些也是Redis常用的功能</font>。<font color='red'>在高并发的场景下，往往我们需要保证数据的一致性，这时考虑使用Redis事务或者利用Redis执行的原子性来达到数据一致性的目的，在需要大批量执行Redis命令的时候，我们可以使用流水线来执行命令，这样可以极大的提升Redis执行速度。</font></p>
<h3 id="使用Redis事务"><a href="#使用Redis事务" class="headerlink" title="使用Redis事务"></a>使用Redis事务</h3><p>在Redis中使用事务，通常的命令组合是watch…multi…exec，也就是要在一个Redis连接中执行多个命令，这时我们考虑使用SessionCallback接口达到这个目的。</p>
<ul>
<li>watch：监控Redis的一些键</li>
<li>multi：开始事务，开始后不会马上执行，而是放在一个队列里，所以此时调用Redis的命令，结果都是返回null</li>
<li>exec：执行事务，只是在执行前会判断被watch监控的Redis的键的数据是否发生变化，如果他认为发生了变化，那么Redis就会取消事务，否则就会执行事务，Redis在执行事务时，要么全部执行，要么全部不执行，而且不会被其他客户端打断<img src="/2019/05/25/%E7%AC%AC7%E7%AB%A0-%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8Redis/screenshot_1.png" class="">
下面测试这样的一个过程，只是这里需要保证RedisTemplate的键和散列结构的field使用字符串序列化器<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 使用Redis事务机制</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>: []</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>: java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: zp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/8/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/multi&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">multi</span><span class="params">()</span></span>&#123;</span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;key1&quot;</span>,<span class="string">&quot;value1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    List list = (List) redisTemplate.execute((RedisOperations operations) -&gt; &#123;</span><br><span class="line">        <span class="comment">//设置要监控key1</span></span><br><span class="line">        operations.watch(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        <span class="comment">//开启事务，在exec命令执行前，全部都只是进入队列</span></span><br><span class="line">        operations.multi();</span><br><span class="line">        operations.opsForValue().set(<span class="string">&quot;key2&quot;</span>,<span class="string">&quot;value2&quot;</span>);</span><br><span class="line">        <span class="comment">//operations.opsForValue().increment(&quot;key&quot;,1);//①</span></span><br><span class="line">        <span class="comment">//获取值降为null，因为redis只是把命令放入到队列</span></span><br><span class="line">        Object value2 = operations.opsForValue().get(<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;命令在队列，所以value为null【&quot;</span>+value2+<span class="string">&quot;】&quot;</span>);</span><br><span class="line">        operations.opsForValue().set(<span class="string">&quot;key3&quot;</span>,<span class="string">&quot;value3&quot;</span>);</span><br><span class="line">        Object value3 = operations.opsForValue().get(<span class="string">&quot;key3&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;命令在队列，所以value为null【&quot;</span>+value3+<span class="string">&quot;】&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行exec命令，将先判断key1是否在监控后被修改过，如果是则不执行事务，否则执行事务</span></span><br><span class="line">        <span class="keyword">return</span> operations.exec();<span class="comment">//②</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    System.out.println(list);</span><br><span class="line"></span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;success&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
为了揭示Redis事务的特性，我们对这段代码做一下两种测试</li>
<li>现在Redis客户端情况key2和key3两个键的数据，然后在②处设置断点，在调试的环境下让请求到断点，此时在Redis修改key1的值，然后跳过断点，在请求完成后再Redis上查询key2和key3的值，可以发现key2、key3返回的都是空（nil），因为程序中先使得Redis的watch命令监控了key1的值，而后的multi让之后的命令进入队列，而在exec方法运行前我们修改了key1，根据Redis事务的规则，她在exec方法后会探测key1是否被修改过，如果没有则会执行事务，否则就取消事务，所以key2和key3没有被保存到Redis服务器中</li>
<li>继续把key2和key3两个值清空，把①处的注释取消，让代码可以运行，因为key1是一个字符串，所以这里代码是对字符串加一，这显然是不能运算的。同样的，我们运行这段代码后，可以看到服务器抛出了异常，然后我们去Redis服务查询key2和key3，<font color='red'>我们可以看到它们已经有值了。这是Redis事务和数据库事务不一样，对于Redis事务是先让命令进入队列，所以一开始他并没有检测这个加一命令是否能够成功，只是exec命令执行的时候，才发现错误，对于出错的命令Redis只是报出错误，而错误后面的命令已久被执行，所以key2和key3都存在数据</font>。为了克服这个问题，一般我们要在执行Redis事务前，要严格地检查数据，以避免这样的情况发生。</li>
</ul>
<h3 id="使用Redis流水线"><a href="#使用Redis流水线" class="headerlink" title="使用Redis流水线"></a>使用Redis流水线</h3><p>在系统的默认情况，Redis客户端是一条条发送给Redis服务器，这样显然性能不高。早关系数据库我们可以使用批量，这也是只有需要执行SQL时，才一次性地发送所有SQL去执行，这样性能就提高了许多。对于Redis也是可以的，这边事流水线（pipeline）技术，使用流水线后就可以大幅度的在需要执行很多命令时提升Redis的性能<br>下面我们使用Redis流水线技术测试10万次读取的功能，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 使用Redis流水线测试性能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>: []</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>: java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: zp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/8/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/pipeline&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">pipeline</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Long start = System.currentTimeMillis();</span><br><span class="line">    List list = (List)redisTemplate.executePipelined((RedisOperations operations)-&gt;&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=<span class="number">100000</span>; i++)&#123;</span><br><span class="line">            operations.opsForValue().set(<span class="string">&quot;pipeline_&quot;</span>+i,<span class="string">&quot;value_&quot;</span>+i);</span><br><span class="line">            String value = (String)operations.opsForValue().get(<span class="string">&quot;pipeline_&quot;</span>+i);</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">100000</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;命令指示进入队列，所以值为空【&quot;</span>+value+<span class="string">&quot;】&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Long end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;耗时:&quot;</span>+(end-start)+<span class="string">&quot;毫秒。&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;success&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里沿用SessionCallback接口执行写入和读出各10万次Redis，只是修改为了Lamdba表达式而已。测试中，10万次读写基本保持200-600ms，速度十分快。在使用非流水线的情况下，美妙大概执行2-3万条命令，流水线可以提升10倍速度，十分适合大数据量的执行。<br>这里需要注意的是以下两点</p>
<ul>
<li>这里只是测试，常规情况下一定要考虑内存控件的消耗，他最终返回一个List对象，如果过多的命令执行返回结果保存在List中，显然会内存小号过大，尤其在高并发的网站中就很容易JVM移除异常，这个时候考虑使用迭代的方法执行Redis命令</li>
<li>与实务一样，使用流水线的过程中，所有的命令也只是进入队列而没有执行，所以执行的命令返回也是空</li>
</ul>
<h3 id="使用Redis发布订阅"><a href="#使用Redis发布订阅" class="headerlink" title="使用Redis发布订阅"></a>使用Redis发布订阅</h3><ol>
<li>Redis消息监听器<br><font color='red'>发布订阅是消息的一种常用模式</font> 。例如，在企业分配任务之后，可以通过邮件、短信或者微信通知到相关的责任人，这就是一种典型的发布订阅模式。首先是Redis提供一个渠道，让消息能够发送到这个渠道上，而多个系统可以监听这个渠道，如短信、微信或者邮件系统都可以监听这个渠道，当一条消息发送到渠道，渠道就会通知它的坚挺着，这样短信、微信和右键系统就能够得到这个渠道给他们的消息了，这些坚挺着会根据自己的需要去处理这个消息，于是我们就可以得到各种各样的通知了。原理如下图所示<img src="/2019/05/25/%E7%AC%AC7%E7%AB%A0-%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%A9%E5%99%A8Redis/screenshot_2.png" class="">
为了接收Redis渠道发送过来的消息，我们先定义一个消息监听器（MessageListener）,代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyd.mc.demo.redis.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.MessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@project</span>: mc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: Redis监听器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: zp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2019-08-10 18:35</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"> <span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//消息体</span></span><br><span class="line">        String body = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">        <span class="comment">//渠道名称</span></span><br><span class="line">        String topic = <span class="keyword">new</span> String(bytes);</span><br><span class="line">        System.out.println(body);</span><br><span class="line">        System.out.println(topic);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里的onMessage方法是得到消息后的处理方法，其中message参数代表Redis发送过来的消息，pattern是渠道名称，onMessage方法是打印了他们的内容。这里因为标注了@Component注解，所以Spring Boot扫描后，会把它自动装配到IoC容器中<br>接着我们在Spring Boot的启动文件中配置其他信息，让系统能够监听Redis的消息，代码如下</li>
<li>监听Redis发布的消息<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Redis连接工厂</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Redis消息监听器</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MessageListener redisMsgListener;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//任务池</span></span><br><span class="line"><span class="keyword">private</span> ThreadPoolTaskScheduler taskScheduler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建任务池，运行线程等待处理Redis的消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ThreadPoolTaskScheduler <span class="title">initTaskScheduler</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(taskScheduler != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> taskScheduler;</span><br><span class="line">    &#125;</span><br><span class="line">    taskScheduler = <span class="keyword">new</span> ThreadPoolTaskScheduler();</span><br><span class="line">    taskScheduler.setPoolSize(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">return</span> taskScheduler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义Redis的监听容器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 监听容器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">initRedisContainer</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">    <span class="comment">//Redis 连接工厂</span></span><br><span class="line">    container.setConnectionFactory(connectionFactory);</span><br><span class="line">    <span class="comment">//设置运行任务池</span></span><br><span class="line">    container.setTaskExecutor(initTaskScheduler());</span><br><span class="line">    <span class="comment">//定义监听渠道，名称为topic1</span></span><br><span class="line">    Topic topic = <span class="keyword">new</span> ChannelTopic(<span class="string">&quot;topic1&quot;</span>);</span><br><span class="line">    <span class="comment">//使用监听器监听Redis的消息</span></span><br><span class="line">    container.addMessageListener(redisMsgListener,topic);</span><br><span class="line">    <span class="keyword">return</span> container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里RedisTemplate和RedisConnectionFactory对象都是Spring Boot自动创建的，所以这里只是把他们注入进来。然后定义了一个任务池，并设置了任务池的大小为20，这样它将可以运行线程，并进行阻塞，等待Redis消息的传入。接着定义了一个Redis消息，监听的容器RedisMessageListenerContainer，并且网容器设置了Redis连接工厂和指定运行消息的线程池，定义了接收“topic1”渠道的消息，这样系统就可以监听Redis关于topic1渠道的消息了。<br>启动项目后，在Redis的客户端输入命令：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publish topic1 msg</span><br></pre></td></tr></table></figure>
在Spring中，我们也可以使用RedisTemplate来发送消息，例如：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.convertAndSend(channel,messgae);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="使用Lua脚本"><a href="#使用Lua脚本" class="headerlink" title="使用Lua脚本"></a>使用Lua脚本</h3><p>Redis中Lua脚本执行的方式有两种：</p>
<ul>
<li>直接发送Lua到Redis服务器执行</li>
<li>先把Lua发送给Redis，Redis对Lua脚本缓存，然后返回一个SHA1的32位编码回来，之后需要发送SHA1和相关参数给Redis便可以执行。（这是因为如果Lua脚本比较长的时候，网络会成为瓶颈，但是如果只发32位编码和参数就轻松的多）</li>
</ul>
<ol>
<li>RedisScript接口定义</li>
</ol>
<ul>
<li>getSha1：方法可以得到Redis返回的32位编码</li>
<li>getResultType：获取Lua脚本返回的Java类型</li>
<li>getScriptAsString：返回脚本的字符串，便于观看脚本</li>
</ul>
<ol start="2">
<li><p>执行简单的Lua</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 执行简易Lua</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>: []</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>: java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: zp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/8/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/lua&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">lua</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    DefaultRedisScript&lt;String&gt; rs = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;();</span><br><span class="line">    <span class="comment">//设置脚本</span></span><br><span class="line">    rs.setScriptText(<span class="string">&quot;return &#x27;Hello Redis&#x27;&quot;</span>);</span><br><span class="line">    <span class="comment">//定义返回类型。注意：如果没有这个定义，Spring不会反悔结果</span></span><br><span class="line">    rs.setResultType(String.class);</span><br><span class="line"></span><br><span class="line">    RedisSerializer&lt;String&gt; stringRedisSerializer = redisTemplate.getStringSerializer();</span><br><span class="line">    <span class="comment">//执行Lua脚本</span></span><br><span class="line">    String str = (String)redisTemplate.execute(rs,stringRedisSerializer,stringRedisSerializer,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;success&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先Lua只是定义了一个简单的字符串，然后就返回了，而返回类型则定义为字符串。这里必须定义返回类型，否则对于Spring不会把脚本执行的结果返回。接着获取了由RedisTemplate自动创建的字符串序列化器，然后使用RedisTemplate的execute方法执行了脚本</p>
</li>
<li><p>执行复杂的Lua脚本<br>下面考虑存在参数的情况，Lua脚本代码如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>,KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>])</span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>,KEYS[<span class="number">2</span>], ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">local</span> str1 = redis.call(<span class="string">&#x27;get&#x27;</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> str1 = redis.call(<span class="string">&#x27;get&#x27;</span>,KEYS[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">if</span> str1 == str2 <span class="keyword">then</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>这里的脚本中使用了两个键去保存两个参数，然后对这两个参数进行比较，如果相等返回1，否则返回0.注意脚本中<code>KEY[1]</code>和<code>KEY[2]</code>的写法，它代表客户端传递的第一个键和第二个键。而<code>ARGV[1]</code>和<code>ARGV[2]</code>则表示客户端传递的第一个和第二个参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 执行复杂Lua</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>: []</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>: java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: zp</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/8/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/luaComplexScript&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">luaComplexScript</span><span class="params">(String key1,String key2,String value1,String value2)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义Lua脚本</span></span><br><span class="line">    StringBuffer luaScript = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    luaScript.append(<span class="string">&quot; redis.call(&#x27;set&#x27;,KEYS[1], ARGV[1]) &quot;</span>);</span><br><span class="line">    luaScript.append(<span class="string">&quot; redis.call(&#x27;set&#x27;,KEYS[2], ARGV[2]) &quot;</span>);</span><br><span class="line">    luaScript.append(<span class="string">&quot; local str1 = redis.call(&#x27;get&#x27;,KEYS[1]) &quot;</span>);</span><br><span class="line">    luaScript.append(<span class="string">&quot; local str1 = redis.call(&#x27;get&#x27;,KEYS[2]) &quot;</span>);</span><br><span class="line">    luaScript.append(<span class="string">&quot; if str1 == str2 then &quot;</span>);</span><br><span class="line">    luaScript.append(<span class="string">&quot; return 1 &quot;</span>);</span><br><span class="line">    luaScript.append(<span class="string">&quot; end &quot;</span>);</span><br><span class="line">    luaScript.append(<span class="string">&quot; return 0 &quot;</span>);</span><br><span class="line">    System.out.println(luaScript.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//结果返回Long</span></span><br><span class="line">    DefaultRedisScript&lt;Long&gt; rs = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;();</span><br><span class="line">    rs.setScriptText(luaScript.toString());</span><br><span class="line">    rs.setResultType(Long.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//采用字符串序列表</span></span><br><span class="line">    RedisSerializer&lt;String&gt; stringRedisSerializer = redisTemplate.getStringSerializer();</span><br><span class="line">    <span class="comment">//定义key参数</span></span><br><span class="line">    List&lt;String&gt; keyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    keyList.add(key1);</span><br><span class="line">    keyList.add(key2);</span><br><span class="line">    <span class="comment">//传递两个参数值，其中第一个序列化器是key的序列化器，第二个序列化器是参数的序列化器</span></span><br><span class="line">    Long result = (Long)redisTemplate.execute(rs,stringRedisSerializer,stringRedisSerializer,keyList,value1,value2);</span><br><span class="line"></span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;success&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用keyList保存了各个键，然后通过Redis的execute方法传递，参数则可以使用可变化的方式传递，切设置了给键和参数的序列化器都是字符串序列化器，这样便能够运行这段脚本了，我们的脚本返回一个数字，这里值得注意的是，因为Java会把证书当做长整型（Long），所以这里返回值设置为Long</p>
</li>
</ol>
<h2 id="使用Spring缓存注解操作Redis"><a href="#使用Spring缓存注解操作Redis" class="headerlink" title="使用Spring缓存注解操作Redis"></a>使用Spring缓存注解操作Redis</h2><p>为了简化Redis使用，Spring提供了缓存注解，简化了编程过程</p>
<h3 id="缓存管理器和缓存的启用"><a href="#缓存管理器和缓存的启用" class="headerlink" title="缓存管理器和缓存的启用"></a>缓存管理器和缓存的启用</h3><p>Spring的支持多种缓存管理机制，咱们这里只需设置Redis相关的使用方式，以下列出Spring缓存的配置内容</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cache.cache-name</span>=<span class="string">#如果由底层的缓存管理器支持创建，以逗号分割的列表来缓存名称</span></span><br><span class="line"><span class="meta">spring.cache.caffeine.spec</span>=<span class="string">#caffeine缓存配置细节</span></span><br><span class="line"><span class="meta">spring.cache.couchbase.expiration</span>=<span class="string">0ms # couchbase缓存超时时间，默认是用不超时</span></span><br><span class="line"><span class="meta">spring.cache.ehcache.config</span>= <span class="string">#配置ehcache缓存初始化文件路径</span></span><br><span class="line"><span class="meta">spring.cache.infinispan.config</span>=<span class="string">#infinispan缓存配置文件</span></span><br><span class="line"><span class="meta">spring.cache.jcache.config</span>= <span class="string">#jcache缓存配置文件</span></span><br><span class="line"><span class="meta">spring.cache.jcache.provider</span>= <span class="string"># jcache缓存提供者配置</span></span><br><span class="line"><span class="meta">spring.cache.redis.cache-null-values</span>=<span class="string">true#是否允许Redis缓存空值</span></span><br><span class="line"><span class="meta">spring.cache.redis.key-prefix</span>= <span class="string">#Redis的键前缀</span></span><br><span class="line"><span class="meta">spring.cache.redis.time-to-live</span>=<span class="string">0ms #缓存超时时间戳，配置为0则不设置超时时间</span></span><br><span class="line"><span class="meta">spring.cache.redis.user-key-prefix</span>=<span class="string">true #是否启用Redis的键前缀</span></span><br><span class="line"><span class="meta">spring.cache,type</span>= <span class="string">#缓存类型，在默认的情况下，Spring会自动根据上下文探测,多个名称可以使用逗号分割</span></span><br></pre></td></tr></table></figure>
<p>因为知识使用Redis，所以其他的缓存不关注，只是关注和Redis相关的配置，下面在application.properties配置Redis的缓存管理器，代码如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cache.type</span>=<span class="string">redis</span></span><br><span class="line"><span class="meta">spring.cache.cache-names</span>=<span class="string">redisCache</span></span><br></pre></td></tr></table></figure>
<p>这样就完成了缓存管理器的配置，这里的spring.cache.type配置的是缓存类型为Redis，Spring Boot会自动生成RedisCacheManager对象，而spring.cache.cache-names则是配置缓存名称，<br>为了使用缓存管理器，需要在Spring Boot的配置文件中加入驱动缓存的注解@EnableCacheig，这样就可以驱动Spring缓存机制工作了，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.xyd.mc&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EntityScan(basePackages = &quot;com.xyd.mc.*.*.pojo&quot;)</span></span><br><span class="line"><span class="meta">@MapperScan(</span></span><br><span class="line"><span class="meta">    basePackages = &quot;com.xyd.mc.*&quot;,</span></span><br><span class="line"><span class="meta">    sqlSessionTemplateRef = &quot;sqlSessionTemplate&quot;,</span></span><br><span class="line"><span class="meta">    annotationClass = Repository.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">McApplication</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开发缓存注解"><a href="#开发缓存注解" class="headerlink" title="开发缓存注解"></a>开发缓存注解</h3><ol>
<li>首先配置文件，主要配置数据库、MyBatis、Redis、缓存和日志信息，代码如下<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/spring_boot_chapter5?serverTimezone=UTC</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">zhang1989</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定数据源</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.type</span>=<span class="string">org.apache.commons.dbcp2.BasicDataSource</span></span><br><span class="line"><span class="comment">#最大等待连接中的数量，设0没有限制</span></span><br><span class="line"><span class="meta">spring.datasource.dbcp2.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="comment">#最大连接活动数</span></span><br><span class="line"><span class="meta">spring.datasource.dbcp2.max-total</span>=<span class="string">50</span></span><br><span class="line"><span class="comment">#最大等待毫秒数</span></span><br><span class="line"><span class="meta">spring.datasource.dbcp2.max-wait-millis</span>=<span class="string">10000</span></span><br><span class="line"><span class="comment">#数据库连接池初始化连接数</span></span><br><span class="line"><span class="meta">spring.datasource.dbcp2.initial-size</span>=<span class="string">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Mybatis映射文件通配</span></span><br><span class="line"><span class="meta">mybatis.mapper-locations</span>=<span class="string">mapper/*/*/*Mapper.xml</span></span><br><span class="line"><span class="comment">#MyBatis扫描别名包和注解Alias连用</span></span><br><span class="line"><span class="meta">mybatis.type-aliases-package</span>=<span class="string">com.xyd.mc.*.*.pojo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Redis</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.min-idle</span>=<span class="string">5</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">2000ms</span></span><br><span class="line"><span class="comment">#配置Redis服务器属性</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment">#Redis连接超时时间，单位毫秒</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">1000ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缓存配置</span></span><br><span class="line"><span class="meta">spring.cache.type</span>=<span class="string">redis</span></span><br><span class="line"><span class="meta">spring.cache.cache-names</span>=<span class="string">redisCache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#日志配置</span></span><br><span class="line"><span class="comment">#logging.level.root=debug</span></span><br><span class="line"><span class="comment">#logging.level.org.springframework=debug</span></span><br><span class="line"><span class="comment">#logging.level.org.org.mybatis=debug</span></span><br></pre></td></tr></table></figure></li>
<li>创建一个POJO-User来对应数据库的表，代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyd.mc.demo.database.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.Alias;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Alias(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7760614561073458247L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    <span class="comment">/***setter and getter*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这个类实现了Serializable接口，说明它是可以进行序列化</li>
<li>为了提供操作，需要设计一个接口来实现MyBatis，代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyd.mc.demo.database.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xyd.mc.demo.database.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取单个用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">getUser</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户，执行MyBatis的参数名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> note</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findUsers</span><span class="params">(<span class="meta">@Param(&quot;userName&quot;)</span> String userName, <span class="meta">@Param(&quot;note&quot;)</span> String note)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteUser</span><span class="params">(Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>为了配合这个接口一期使用，我们需要使用一个XML来定义SQL、映射关系、参数和返回等信息，代码如下<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.xyd.mc.demo.database.dao.UserDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">        select id, user_name as userName,note from t_user where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;user&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        insert into t_user(user_name,note) value(#&#123;userName&#125;,#&#123;note&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateUser&quot;</span>&gt;</span></span><br><span class="line">        update t_user</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userName != null&quot;</span>&gt;</span> user_name = #&#123;userName&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;note != null&quot;</span>&gt;</span> note = #&#123;note&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findUsers&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">        select id, user_name as UserName,note from t_user</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userName != null&quot;</span>&gt;</span></span><br><span class="line">                and user_name = #&#123;userName&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;note != null&quot;</span>&gt;</span></span><br><span class="line">                and note = #&#123;note&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span>&gt;</span></span><br><span class="line">        delete from t_user where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>为了整合它，我们还需要使用Spring的机制，为此定义一个Spring的服务接口UserService，代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyd.mc.demo.database.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xyd.mc.demo.database.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取单个用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">insertUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户，指定MyBatis的参数名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">updateUserName</span><span class="params">(Long id,String userName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> note</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findUsers</span><span class="params">(String userName, String note)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteUser</span><span class="params">(Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>这样就定义了Spring服务接口的方法，接着需要实现这个接口，<font color='red'>这里我们使用缓存注解，因为UserService的实现类是本节的重要代码</font><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyd.mc.demo.database.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xyd.mc.demo.database.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> com.xyd.mc.demo.database.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.xyd.mc.demo.database.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CachePut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取id，取参数id缓存用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED,timeout = 1)</span></span><br><span class="line">    <span class="comment">//如果能在缓存中通过定义键查询到，直接将缓存中查询到的数据返回，否则执行方法，并将结果保存到缓存</span></span><br><span class="line">    <span class="meta">@Cacheable(value=&quot;redisCache&quot;, key = &quot;&#x27;redis_user_&#x27;+#id&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.getUser(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入用户，最后MyBatis会回填id，取结果id缓存用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED,propagation = Propagation.REQUIRES_NEW,rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="meta">@CachePut(value=&quot;redisCache&quot;, key = &quot;&#x27;redis_user_&#x27;+#user.id&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">insertUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userDao.insertUser(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新数据后，更新缓存，如果condition配置项使结果返回nul，不缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@CachePut(value=&quot;redisCache&quot;,condition = &quot;#result != &#x27;null&#x27;&quot;,key = &quot;&#x27;redis_user_&#x27;+#id&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">updateUserName</span><span class="params">(Long id, String userName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//此处调用getUser方法，该方法缓存注解失效</span></span><br><span class="line">        <span class="comment">//所以这里还会执行SQL，将查询到数据库最新数据</span></span><br><span class="line">        User user = <span class="keyword">this</span>.getUser(id);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        user.setUserName(userName);</span><br><span class="line">        userDao.updateUser(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 命中率低，所以不采用缓存机制</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> note</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findUsers</span><span class="params">(String userName, String note)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findUsers(userName,note);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;redisCache&quot;,key = &quot;&#x27;redis_user_&#x27;+#id&quot;,beforeInvocation = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUser</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.deleteUser(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
注解@CachePut、@Cacheable、@CacheEvict</li>
</ol>
<ul>
<li>CachePut：将方法结果返回存放到缓存中</li>
<li>Cacheable：从缓存中通过定义的键查询，如果可以查询到数据，则返回，否则执行该方法，返回数据，并且将结果保存到缓存中</li>
<li>CacheEvict：通过定义的键移除缓存，她有一个Boolean类型的配置项beforeInvocation，表示在方法之前或者之后移除缓存，因为默认值为false，所以默认为方法之后将缓存移除<br>其次，读者可以看到三个缓存中都配置了value=”redisCache”，因为在Spring Boot中配置了对应的缓存名称为redisCache，这样它能够引用到对应的缓存，而配置项则是一个Spring EL，很多时候可以看到配置为’redis_user_’+#id，其中#id代表参数，他是通过参数名称来匹配，所以这样配置要求方法存在一个参数且名称为id；在updateUser方法里面我们先调用了getUser方法，因为是更新数据，所以需要慎重。<font color='red'>一般我们不轻易相信缓存，因为缓存存在脏读的可能性，这是需要注意得，在需要更新数据时我们往往考虑先从数据库查询出来新数据，然后再进行操作，因此，这里会存在一个误区，认为geUser方法因为存在了注解Cacheable，所以惠存缓存中读取数据，耳聪缓存中读取去更新数据，是一个比较危险的行为，因为、、然后这里的事实是@Cacheable失效了，也就是说updateUserName方法调用getUser方法的逻辑，并不存在读取缓存的可能，每次都会执行SQL查询数据。</font>最后，我们看到findUser，这个方法并没有使用缓存，因为查询结果随着用户给出的查询条件变化而变化，导致命中率很低。对于命中很低的场景，使用缓存并不能有效的提高系统的性能，所以不推荐缓存机制，此外，对于数据量很小号的数据，使用缓存也应该慎重。</li>
</ul>
<ol start="7">
<li>接下来创建一个Controller，进行缓存注解的测试<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyd.mc.demo.database.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xyd.mc.demo.database.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.xyd.mc.demo.database.service.UserBatchService;</span><br><span class="line"><span class="keyword">import</span> com.xyd.mc.demo.database.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserBatchService userBatchService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getUser&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUser(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/insertUser&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">insertUser</span><span class="params">(String userName,String note)</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUserName(userName);</span><br><span class="line">        user.setNote(note);</span><br><span class="line">        <span class="comment">//结果回填主键，返回插入条数</span></span><br><span class="line">        userService.insertUser(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/findUsers&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findUsers</span><span class="params">(String userName,String note)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUsers(userName,note);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/updateUserName&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">updateUserName</span><span class="params">(Long id, String userName)</span></span>&#123;</span><br><span class="line">        User user = userService.updateUserName(id,userName);</span><br><span class="line">        <span class="keyword">boolean</span> flag = user != <span class="keyword">null</span>;</span><br><span class="line">        String msg = flag?<span class="string">&quot;更新成功&quot;</span>:<span class="string">&quot;更新失败&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> resultMap(flag,msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/deleteUser&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">deleteUser</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = userService.deleteUser(id);</span><br><span class="line">        <span class="keyword">boolean</span> flag = result == <span class="number">1</span>;</span><br><span class="line">        String msg = flag?<span class="string">&quot;删除成功&quot;</span>:<span class="string">&quot;删除失败&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> resultMap(flag,msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/insertUsers&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">insertUsers</span><span class="params">(String userName1,String note1,String userName2,String note2)</span></span>&#123;</span><br><span class="line">        User user1 = <span class="keyword">new</span> User();</span><br><span class="line">        user1.setUserName(userName1);</span><br><span class="line">        user1.setNote(note1);</span><br><span class="line"></span><br><span class="line">        User user2 = <span class="keyword">new</span> User();</span><br><span class="line">        user2.setUserName(userName2);</span><br><span class="line">        user2.setNote(note2);</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        users.add(user1);</span><br><span class="line">        users.add(user2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> insertCount = userBatchService.insertUsers(users);</span><br><span class="line">        Map&lt;String,Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;success&quot;</span>,insertCount&gt;<span class="number">0</span>);</span><br><span class="line">        result.put(<span class="string">&quot;user&quot;</span>,users);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String,Object&gt; <span class="title">resultMap</span><span class="params">(<span class="keyword">boolean</span> success,String msg)</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;success&quot;</span>,success);</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>,msg);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>接下来需要修改Spring Boot的启动文件驱动缓存机制的运行<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyd.mc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.domain.EntityScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.MessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.ChannelTopic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.Topic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.xyd.mc&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EntityScan(basePackages = &quot;com.xyd.mc.*.*.pojo&quot;)</span></span><br><span class="line"><span class="meta">@MapperScan(</span></span><br><span class="line"><span class="meta">    basePackages = &quot;com.xyd.mc.*&quot;,</span></span><br><span class="line"><span class="meta">    sqlSessionTemplateRef = &quot;sqlSessionTemplate&quot;,</span></span><br><span class="line"><span class="meta">    annotationClass = Repository.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">McApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入RedisTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Redis连接工厂</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Redis消息监听器</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageListener redisMsgListener;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//任务池</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskScheduler taskScheduler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建任务池，运行线程等待处理Redis的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskScheduler <span class="title">initTaskScheduler</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(taskScheduler != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> taskScheduler;</span><br><span class="line">        &#125;</span><br><span class="line">        taskScheduler = <span class="keyword">new</span> ThreadPoolTaskScheduler();</span><br><span class="line">        taskScheduler.setPoolSize(<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">return</span> taskScheduler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义Redis的监听容器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 监听容器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">initRedisContainer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        <span class="comment">//Redis 连接工厂</span></span><br><span class="line">        container.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="comment">//设置运行任务池</span></span><br><span class="line">        container.setTaskExecutor(initTaskScheduler());</span><br><span class="line">        <span class="comment">//定义监听渠道，名称为topic1</span></span><br><span class="line">        Topic topic = <span class="keyword">new</span> ChannelTopic(<span class="string">&quot;topic1&quot;</span>);</span><br><span class="line">        <span class="comment">//使用监听器监听Redis的消息</span></span><br><span class="line">        container.addMessageListener(redisMsgListener,topic);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义自定义后初始化方法</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        initRedisTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置RedisTemplate的序列化器</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initRedisTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisSerializer stringSerializer = redisTemplate.getStringSerializer();</span><br><span class="line">        redisTemplate.setKeySerializer(stringSerializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(stringSerializer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(McApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里定义了MyBatis Mapper的扫描包，并限定了在标注有@Repository的接口才会被扫描，同时使用@EnableCaching驱动Spring的缓存机制运行，并且通过@PostConstruct定义自定义初始化方法去定义RedisTemplate的一些特性<br>运行Spring Boot的启动文件后，通过球球COntroller中的方法，就能够测试缓存注解了。在使用编号1作为参数测试getUser方法后，打开Redis客户端，然后可以查看到对应的缓存信息。<br>Redis机制会使用#{cacheName}:#{key}的形式作为键保存数据，其次对于这个缓存是永远不超时的，这样会带来缓存不会被刷新的问题，这在某些时候会存在刷新不及时的问题，未来我们需要克服这些问题。</li>
</ol>
<h3 id="缓存注解自调用失效问题"><a href="#缓存注解自调用失效问题" class="headerlink" title="缓存注解自调用失效问题"></a>缓存注解自调用失效问题</h3><p>Redis注解自调用的时候跟数据库的事务自调用基本一致，都会失效，是因为Spring中AOP是通过动态代理技术实现的</p>
<h3 id="缓存脏数据说明"><a href="#缓存脏数据说明" class="headerlink" title="缓存脏数据说明"></a>缓存脏数据说明</h3><p>缓存可以使得系统性能大幅度提高，但是也引发了很多问题，其中最为严重的问题时脏数据问题</p>
<table>
<thead>
<tr>
<th align="center">时刻</th>
<th align="left">动作1</th>
<th align="left">动作2</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T1</td>
<td align="left">修改id为1的用户</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">T2</td>
<td align="left">更新数据库数据</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">T3</td>
<td align="left">使用key_1为键保存数据</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">T4</td>
<td align="left"></td>
<td align="left">修改id为1的用户</td>
<td align="left">与动作1操作同一数据</td>
</tr>
<tr>
<td align="center">T5</td>
<td align="left"></td>
<td align="left">更新数据库数据</td>
<td align="left">此时修改数据库数据</td>
</tr>
<tr>
<td align="center">T6</td>
<td align="left"></td>
<td align="left">使用key_2为键保存数据</td>
<td align="left">这样key1位键的缓存就已经是脏数据</td>
</tr>
<tr>
<td align="center">从上表中可以看到T6时刻，因为使用了key_2为键缓存数据，所以会致使动作1以key_1为键的缓存数据为脏数据。这样使用key_1为键读取时，就只能获取脏数据，这只是存在脏数据的可能性之一，还可能存在别的可能，如Redis事务问题，或者其他系统操作而没有刷新Redis缓存等诸多问题。</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">对于数据的读操作，一般而言是允许不是实时数据，如电商网站还存在一些排名榜单，而这个排名往往都不是实时的，会存在延迟，其实对于查询是可以存在延迟的，也就是存在脏数据是允许的。但是如果一个脏数据失踪存在就说不通了，这样会造成数据失真比较痰中。一般对于查询而言，我们可以规定一个时间，让缓存失效，在Redis中可以设置超时时间，当缓存超过超时时间后，则应用不在能够从缓存中获取数据，而只是从数据库中重新获取最新数据，以保证数据失真不至于太大。对于那些要求实时性比较高的数据，我们可以把缓存时间设置的更好一些，这样就会更加频繁的刷新缓存，而不利就是会增加数据的压力，对于那些要求不是很高，则可以使超市时间长一些，这样就可以降低数据库的压力。</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">对于数据的写操作，往往采取的策略就完全不一样，需要谨慎，一般会认为缓存不可信，所以考虑从数据库中先读取最新数据，然后再更新数据，避免将缓存中的脏数据写入数据库，导致出现业务问题。</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="自定义缓存管理器"><a href="#自定义缓存管理器" class="headerlink" title="自定义缓存管理器"></a>自定义缓存管理器</h3><p>我们不希望Spring Boot机制带来的键命名方式，也不希望缓存永不超时，这时我们可以自定义缓存管理器。在Spring中，我们有两种方法定制缓存管理器，一种是通过配置消除缓存键的前缀和自定义超时时间的属性来定制生成RedisCacheManager；另一种方法是不采用Spring Boot为我们生成的方式，而是通过自己的代码创建缓存管理器，尤其是当需要比较多自定义的时候，更加推荐采用自定义的代码</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Spring-Boot/" rel="tag"># Spring Boot</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/05/25/%E7%AC%AC6%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86/" rel="prev" title="第6章 数据库事务处理">
                  <i class="fa fa-chevron-left"></i> 第6章 数据库事务处理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/05/25/%E7%AC%AC8%E7%AB%A0-%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93MongoDB/" rel="next" title="第8章 文档数据库MongoDB">
                  第8章 文档数据库MongoDB <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备19005853号-1 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daniel</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="/js/local-search.js"></script>






  





</body>
</html>
